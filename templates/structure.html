{% extends 'base.html' %}

{% block head %}

<title>LIGYSIS results</title>

<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>

<script src="https://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/event_functions.js"></script>

<script src="https://3Dmol.org/build/3Dmol-min.js"></script>     
<script src="https://3Dmol.org/build/3Dmol.ui-min.js"></script> 


<script> // some variable definitions from the server
    const chartData = {{ data | tojson }}
    const chartColors = {{ colors | tojson }}
    const cc = {{ cc | tojson }}
    const bs_ress_dict = {{ bs_ress_dict | tojson }}
    const proteinId = {{ prot_id | tojson }}
    const segmentId = {{ seg_id | tojson }}
    const segmentName = proteinId + "_" + segmentId
    const segmentReps = {{ segment_reps | tojson }}
    const newChartData = {{ first_site_data | tojson }}

    var surfaceVisible = false;
</script>

{% endblock %}

{% block main %}

<div class="container">
    <div class="row mb-3">
        <div class="col-12 col-sm-8 col-md-6 col-lg-4 col-xl-3">
            <select id="selectSegment" class="form-select" aria-label="Selecting structural segment">
                <option selected>Segment {{ seg_id }} ({{ segment_reps[seg_id | int]["start"] }} - {{ segment_reps[seg_id | int]["end"] }})</option>
                {% for key, value in segment_reps.items() if key != seg_id | int %}
                    <option value="/results/{{ prot_id }}/{{ key }}">Segment {{ key}} ({{ value["start"] }} - {{ value["end"] }})</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="row">
        <div id="3DMolAppletHolder" class="col-lg-7 col-sm-12 d-flex flex-column align-items-center justify-content-center">
            <div class="row mb-3">
                <div style="border: 2px solid black;" class="d-flex px-0">
                    <div id="container-01" style="height: 632px; width: 632px;" class="applet-border d-flex">
                        <script>
                            let element = document.querySelector('#container-01');
                            let config = { backgroundColor: 'white'}  // setting the outline color to red};
                            let viewer = $3Dmol.createViewer( element, config );
                            $3Dmol.setSyncSurface(true); // all surfaces appear at once
                            viewer.setViewStyle({'style':'outline','color':'black','width':0.1})
                            let pdbUri = `/static/data/structures/${segmentReps[segmentId]["rep"]}_trans.pdb`;
                            jQuery.ajax( pdbUri, { 
                                success: function(data) {
                                let v = viewer;
                                v.addModel( data, "pdb" );                       /* load data */
                                v.setStyle({}, {cartoon: {style:'oval', color: 'white', arrows: true}});  /* style all atoms */
                                //v.setSyncSurface(true);
                                v.zoomTo();                                      /* set camera */
                                v.render({});                                    /* render scene */
                                v.zoom(1.2, 100);                                /* slight zoom */
                                },
                                error: function(hdr, status, err) {
                                conerrsole.or( "Failed to load PDB " + pdbUri + ": " + err );
                                },
                            });
                            viewer.resize();
                        </script>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col d-flex">
                    <input id="surfButton" type="button" value="Surface OFF" style="font-weight: bold; color: #674ea7;"
                    onclick="toggleSurfaceVisibility()"></input>
                    <script>
                        function toggleSurfaceVisibility() {
                            var button = document.getElementById('surfButton');
                            if (surfaceVisible) {
                                viewer.removeAllSurfaces(); // Remove the surface
                                button.value = 'Surface OFF'; // Change the button text
                                button.style = "font-weight: bold; color: #674ea7;";
                            }
                            else {
                              // Create and add the surface
                                viewer.addSurface(
                                    $3Dmol.SurfaceType.ISO,
                                    {
                                        color: 'white',
                                        opacity: 0.7,
                                    },
                                { hetflag: false },
                                );
                                button.value = "Surface ON"; // Change the button text
                                button.style = "font-weight: bold; color: #B22222;";
                            }
                            surfaceVisible = !surfaceVisible; // Toggle the visibility state
                            viewer.render();
                        }
                    </script>
                </div>
                <div class="col d-flex">
                    <input type="button" value="Recenter" onclick="viewer.zoomTo();"></input>
                </div>
            </div>
            
        </div>
            
        <div class="col-lg-5 col-sm-12 d-flex flex-column mb-3 justify-content-between">
            <div class="row mb-3 justify-content-center">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover sortable"id="bss_table">
                        <caption>Ligand binding sites and their averaged features</caption>
                        <thead class="fixTableHead">
                            <tr class="table__header">
                                {% for header in headings %}
                                <th class="table__cell">{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(data["lab"]|length) %}
                            <tr class="custom-row" style="color: {{ colors[loop.index0] }} !important;" id="{{ data['lab'][loop.index0] }}">
                                    {% for k in data.keys() %}
                                        <td class="table__cell">{{ data[k][i] }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
            </div>
            <div class="row justify-content-center">
                <div class="row mb-2 justify-content-center">
                    <canvas id="chartCanvas" width="500" height="500"></canvas>
                </div>
                <div class="row justify-content-between">
                    <div class="col-6 d-flex justify-content-center">
                        <select id="xAxisTitle">
                            {% for header in headings[1:] %}
                            <option value="{{ header }}">{{ header }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6 d-flex justify-content-center">
                        <select id="yAxisTitle">
                            {% for header in headings[1:] %}
                            <option value="{{ header }}">{{ header }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col">
            <div class="row mb-2 justify-content-center">
                <canvas id="newChartCanvas" width="650" height="320"></canvas>
            </div>
            <div class="row justify-content-between mb-3">
                <div class="col-6 d-flex justify-content-center">
                    <select id="xAxisTitle2" class="axis-dropdown2 x-axis-dropdown2">
                        <option selected hidden>abs_norm_shenkin</option>
                        {% for header in cc[1:] %}
                        <option value="{{ header }}">{{ header }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-6 d-flex justify-content-center">
                    <select id="yAxisTitle2" class="axis-dropdown2 y-axis-dropdown2">
                        <option selected hidden>oddsratio</option>
                        {% for header in cc[1:] %}
                        <option value="{{ header }}">{{ header }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover sortable" id="bs_ress_table">
                        <thead class="sticky-header">
                            <tr class="table__header">
                                {% for header in cc %}
                                <th class="table__cell">{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody> 
                            {% for i in range(first_site_data["UniProt_ResNum"]|length) %}
                            <tr class="custom-row" style="color: {{ colors[0] }} !important;" id="{{ first_site_data['UniProt_ResNum'][i] }}">
                                    {% for k in first_site_data.keys() %}
                                        <td class="table__cell">{{ first_site_data[k][i] }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/charts.js"></script>
<script src="/static/js/table_listeners.js"></script>
<!-- <script src="/static/js/jsmol_resize.js"></script> -->
<script src="/static/js/3DMol_resize.js"></script>
<script src="/static/js/change_segment.js"></script>

{% endblock%}